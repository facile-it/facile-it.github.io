<!DOCTYPE HTML>

<html>
    <head>
        <script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https:\/\/engineering.facile.it\/"
        },
        "articleSection" : "blog",
        "name" : "Write a filesystem with FUSE",
        "headline" : "Write a filesystem with FUSE",
        "description" : "\u003cp\u003eDuring the past year I experimented a lot with file systems in Userspace using FUSE, I wrote this post to share my thoughts about what I did and to give you a starting point to do something by yourself.\u003c\/p\u003e\n\u003ch1 id=\u0022introduction\u0022\u003eIntroduction\u003c\/h1\u003e\n\u003cp\u003eA filesystem is that piece of software that is in charge of storing, organizing and generally taking care of data represented as files and directories.\nIf you are using a device to read this post you are probably using at least one filesystem at the moment.\u003c\/p\u003e",
        "inLanguage" : "en",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2016",
        "datePublished": "2016-01-11 00:00:00 \u002b0000 UTC",
        "dateModified" : "2016-01-11 00:00:00 \u002b0000 UTC",
        "url" : "https:\/\/engineering.facile.it\/blog\/eng\/write-filesystem-fuse\/",
        "wordCount" : "1692",
        "keywords" : [ "Blog" ]
    }
    </script>
        
            
                <title>Write a filesystem with FUSE</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="referrer" content="always">
        <meta name="generator" content="Hugo 0.134.2">
        


        
        
            
                <meta name="description" content="During the past year I experimented a lot with file systems in Userspace using FUSE, I wrote this post to share my thoughts about what I did and to give you a starting point to do something by yourself.
Introduction
A filesystem is that piece of software that is in charge of storing, organizing and generally taking care of data represented as files and directories.
If you are using a device to read this post you are probably using at least one filesystem at the moment.">
            
        

        
<meta name="twitter:card" content="summary_large_image"/>

    
        <meta name="twitter:image" content="https://engineering.facile.it/images/social/social-preview.png"/>
        <meta name="og:image" content="https://engineering.facile.it/images/social/social-preview.png"/>
    



<meta name="og:title" content="Write a filesystem with FUSE"/>
<meta name="og:description" content="During the past year I experimented a lot with file systems in Userspace using FUSE, I wrote this post to share my thoughts about what I did and to give you a starting point to do something by yourself.
Introduction
A filesystem is that piece of software that is in charge of storing, organizing and generally taking care of data represented as files and directories.
If you are using a device to read this post you are probably using at least one filesystem at the moment."/>


    
        
    



    <meta name="twitter:site" content="@FacileIt_Engr"/>



        <meta property="og:url" content="https://engineering.facile.it/blog/eng/write-filesystem-fuse/">
  <meta property="og:site_name" content="Facile.it Engineering">
  <meta property="og:title" content="Write a filesystem with FUSE">
  <meta property="og:description" content="During the past year I experimented a lot with file systems in Userspace using FUSE, I wrote this post to share my thoughts about what I did and to give you a starting point to do something by yourself.
Introduction A filesystem is that piece of software that is in charge of storing, organizing and generally taking care of data represented as files and directories. If you are using a device to read this post you are probably using at least one filesystem at the moment.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2016-01-11T00:00:00+00:00">
    <meta property="article:modified_time" content="2016-01-11T00:00:00+00:00">


        
            
                <meta property="og:image" content="https://engineering.facile.it/images/social/social-preview.jpg">
            
        

        
  <meta itemprop="name" content="Write a filesystem with FUSE">
  <meta itemprop="description" content="During the past year I experimented a lot with file systems in Userspace using FUSE, I wrote this post to share my thoughts about what I did and to give you a starting point to do something by yourself.
Introduction A filesystem is that piece of software that is in charge of storing, organizing and generally taking care of data represented as files and directories. If you are using a device to read this post you are probably using at least one filesystem at the moment.">
  <meta itemprop="datePublished" content="2016-01-11T00:00:00+00:00">
  <meta itemprop="dateModified" content="2016-01-11T00:00:00+00:00">
  <meta itemprop="wordCount" content="1692">
  <meta itemprop="keywords" content="Lorenzo,English,Fuse,Filesystem,C,CMake">

        
            
        

        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css">
            <link rel="stylesheet" href="/css/main.css">
            <link rel="stylesheet" href="/css/additional.css">
            <link rel="stylesheet" href="/css/add-on.css">
            <link rel="stylesheet" href="/css/academicons.min.css">
        

        


  
    
    <link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/monokai-sublime.min.css' rel='stylesheet' type='text/css' />
  


      
    </head>
    <body>

      
      <div id="wrapper">

    
    
<header id="header">
    
      <h1><a href="/">Facile.it Engineering</a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/categories/">
                            <i class="fa fa-folder-open">&nbsp;</i>Categories
                    </a>
                </li>
            
                <li>
                    <a href="/authors/">
                            <i class="fa fa-pencil">&nbsp;</i>Authors
                    </a>
                </li>
            
                <li>
                    <a href="/ita/careers/">
                            <i class="fa fa-briefcase">&nbsp;</i>Careers
                    </a>
                </li>
            
                <li>
                    <a href="/eng/who-we-are/">
                            <i class="fa fa-users">&nbsp;</i>Who we are
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="as_sitesearch" value="https://engineering.facile.it/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="as_sitesearch" value="https://engineering.facile.it/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/categories/">
                            <h3>
                                <i class="fa fa-folder-open">&nbsp;</i>Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/authors/">
                            <h3>
                                <i class="fa fa-pencil">&nbsp;</i>Authors
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/ita/careers/">
                            <h3>
                                <i class="fa fa-briefcase">&nbsp;</i>Careers
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/eng/who-we-are/">
                            <h3>
                                <i class="fa fa-users">&nbsp;</i>Who we are
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section class="recent-posts">
            <div class="mini-posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                

                
                    
                

                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/eng/hack-the-box-experience/">Hack the Box Experience</a></h3>
                                
                                <time class="published" datetime=
                                    '2024-05-30'>
                                    May 30, 2024</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/eng/v-protetto17-5-2024/">Venerdì Protetto | May 2024 edition</a></h3>
                                
                                <time class="published" datetime=
                                    '2024-05-20'>
                                    May 20, 2024</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/eng/v-protetto8-3-2024/">Venerdì Protetto | March edition</a></h3>
                                
                                <time class="published" datetime=
                                    '2024-03-11'>
                                    March 11, 2024</time>
                            </header>
                            

                        </article>
                

                
                    <a href=
                        
                            /blog/
                        
                        class="button">View more posts</a>
                
            </div>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa-solid fa-smile-o"></i></h3>
            </header>
            



<li>
  <a href="//x.com/share?url=https%3a%2f%2fengineering.facile.it%2fblog%2feng%2fwrite-filesystem-fuse%2f&amp;text=Write%20a%20filesystem%20with%20FUSE&amp;via=FacileIt_Engr" target="_blank" class="share-btn twitter">
    <i class="fa-brands fa-square-x-twitter"></i>
    <p>X</p>
    </a>
</li>





<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fengineering.facile.it%2fblog%2feng%2fwrite-filesystem-fuse%2f" target="_blank" class="share-btn facebook">
    <i class="fa-brands fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>




<li>
  <a href="//reddit.com/submit?url=https%3a%2f%2fengineering.facile.it%2fblog%2feng%2fwrite-filesystem-fuse%2f&amp;title=Write%20a%20filesystem%20with%20FUSE" target="_blank" class="share-btn reddit">
    <i class="fa-brand fa-reddit-alien"></i>
    <p>Reddit</p>
  </a>
</li>




<li>
  <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fengineering.facile.it%2fblog%2feng%2fwrite-filesystem-fuse%2f&amp;title=Write%20a%20filesystem%20with%20FUSE" target="_blank" class="share-btn linkedin">
      <i class="fa-brand fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>




<li>
  <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fengineering.facile.it%2fblog%2feng%2fwrite-filesystem-fuse%2f&amp;title=Write%20a%20filesystem%20with%20FUSE" target="_blank" class="share-btn stumbleupon">
    <i class="fa-brand fa-stumbleupon"></i>
    <p>StumbleUpon</p>
  </a>
</li>




<li>
  <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fengineering.facile.it%2fblog%2feng%2fwrite-filesystem-fuse%2f&amp;description=Write%20a%20filesystem%20with%20FUSE" target="_blank" class="share-btn pinterest">
    <i class="fa-brand fa-pinterest-p"></i>
    <p>Pinterest</p>
  </a>
</li>




<li>
  <a href="mailto:?subject=Check out this post by &amp;body=https%3a%2f%2fengineering.facile.it%2fblog%2feng%2fwrite-filesystem-fuse%2f" target="_blank" class="share-btn email">
    <i class="fa-solid fa-envelope"></i>
    <p>Email</p>
  </a>
</li>


        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
  <header>
    <div class="title">
        
            <h1><a href="/blog/eng/write-filesystem-fuse/">Write a filesystem with FUSE</a></h1>
            
        
        
        
        
    </div>
    <div class="meta">
        

        <time class="published"
            datetime='2016-01-11'>
            11 January 2016
        </time>

        
            <a href="/authors/lorenzo/" class="author">
            
                <span class="name">Lorenzo Fontana</span>
                <img src="https://www.gravatar.com/avatar/3460c18dc12b30037f8937bce6641c4b" alt="Lorenzo Fontana avatar" />
            
            </a>
        

        
            <p>8 minute read</p>
        
    </div>
</header>


  


  

  <div id="content">
    <p>During the past year I experimented a lot with file systems in Userspace using FUSE, I wrote this post to share my thoughts about what I did and to give you a starting point to do something by yourself.</p>
<h1 id="introduction">Introduction</h1>
<p>A filesystem is that piece of software that is in charge of storing, organizing and generally taking care of data represented as files and directories.
If you are using a device to read this post you are probably using at least one filesystem at the moment.</p>
<p>Implementing a filesystem is not an easy task to accomplish and requires that a few parts of it have to be written at kernel level, fortunately that&rsquo;s not our case since we are not writing a real on-disk filesystem, but rather we want to write something on top of it to solve a specific problem.</p>
<p>The most common tool to do that in user space is precisely <strong>FUSE, Filesystem in USErspace</strong>.</p>
<p>There are a lot of filesystem examples built on top of FUSE out there that cover the most different use cases like:</p>
<ul>
<li><a href="https://www.gluster.org/">GlusterFS</a>: scalable network filesystem</li>
<li><a href="https://github.com/libfuse/sshfs">SSHFS</a>: allows mounting a remote filesystem over SSH</li>
<li><a href="https://sr71.net/projects/gmailfs/">GMailFS</a>: allows to use GMail storage as a filesystem</li>
<li><a href="http://loggedfs.sourceforge.net/">LoggedFS</a>: filesystem that logs operations that happens in it</li>
</ul>
<p>The main <strong>advantages</strong> of FUSE over writing a low level kernel filesystem are:</p>
<ul>
<li>Is usable by non-privileged users;</li>
<li>Clean and easy interface to do FS operations;</li>
<li>Has bindings in most available programming language;</li>
<li>No need of advanced kernel development skills;</li>
<li>Comes with user isolation, more secure;</li>
<li>Since you are not hacking in kernel space there are a few chances that a crash in your program takes down the entire system;</li>
</ul>
<p>However there are also a few <strong>disadvantages</strong> of this approach:</p>
<ul>
<li>The target system need libfuse installed;</li>
<li>Slower than low level implementations;</li>
<li>Not the best option if you need multiple users to access your filesystem;</li>
</ul>
<p>Here&rsquo;s a flow-chart diagram showing how FUSE works, source: <a href="https://commons.wikimedia.org/wiki/File:FUSE_structure.svg">Wikimedia Commons</a>
<img src="/images/write-filesystem-fuse/FUSE_structure.svg" alt="A flow-chart diagram showing how FUSE works"></p>
<h1 id="getting-started-with-fuse">Getting started with FUSE</h1>
<p>This section of the post is designed to introduce you on how to practically get your hands dirt with FUSE. Anyway you can understand what&rsquo;s going on whether you execute the code or not.</p>
<h2 id="build-dependencies">Build dependencies</h2>
<p>From now you&rsquo;ll need a few build dependencies and a text editor or an IDE to build and edit the code and do your experiments.</p>
<h3 id="linux">Linux</h3>
<ul>
<li>GCC or Clang</li>
<li>CMake &gt;= 3</li>
<li>make</li>
<li>FUSE 2.6 or later</li>
<li>FUSE development files</li>
</ul>
<p>To obtain those dependencies you can issue the following commands (depending on your Linux distribution).</p>
<p>Fedora/CentOS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install gcc fuse fuse-devel make cmake
</span></span></code></pre></div><p>Debian/Ubuntu</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt-get install gcc fuse libfuse-dev make cmake
</span></span></code></pre></div><h3 id="mac-osx">Mac OSX</h3>
<ul>
<li>Command line tools for Xcode (contains Clang and make)</li>
<li>CMake &gt;= 3</li>
<li>FUSE &gt;= 2.6 or later</li>
<li>FUSE development files</li>
</ul>
<p>You can obtain all the needed dependencies at the following sources:</p>
<ul>
<li><a href="https://developer.apple.com/xcode/features/">Xcode</a></li>
<li><a href="https://cmake.org/download/">CMake</a></li>
<li><a href="https://osxfuse.github.io/">OSXFuse</a></li>
</ul>
<h2 id="fuse-api">FUSE API</h2>
<p>The most important thing to be aware of when working with FUSE is its API.
The libfuse library exposes a set of callbacks that you have to implement in order to tell your filesystem how to behave.</p>
<p>The most complete source of documentation on what are the callbacks and their behavior is the <code>fuse.h</code> declaration file. You can find an online version <a href="https://github.com/libfuse/libfuse/blob/579c3b03f57856e369fd6db2226b77aba63b59ff/include/fuse.h#L102-L577">here</a>.</p>
<h2 id="example-project">Example project</h2>
<p>For the purpose of showing you how simple is the creation of a FUSE filesystem, I wrote this little implementation that, when mounted, only exposes a file named <code>file</code> and its content.</p>
<p>You can find the example project on <a href="https://github.com/fntlnz/fuse-example">GitHub</a>.</p>
<p>I think that the best way to start your own implementation is to take an example and start adding your features.</p>
<p>So, as first thing clone the example project:</p>
<pre tabindex="0"><code>git clone https://github.com/fntlnz/fuse-example.git
</code></pre><p>As you can see the project structure is quite simple:</p>
<pre tabindex="0"><code>.
├── CMake
│   └── FindFUSE.cmake
├── CMakeLists.txt
└── fuse-example.c
</code></pre><h3 id="cmakeliststxthttpsgithubcomfntlnzfuse-exampleblobmastercmakeliststxt"><a href="https://github.com/fntlnz/fuse-example/blob/master/CMakeLists.txt">CMakeLists.txt</a></h3>
<p>As you may know CMake is a tool used to manage project builds in a cross platform way. The scope of this file is to define what CMake is supposed to do for our project. The <code>CMake/FindFuse.cmake</code> is needed in order to tell CMake where to find the FUSE related things while compiling/linking.</p>
<h3 id="fuse-examplechttpsgithubcomfntlnzfuse-exampleblobmasterfuse-examplec"><a href="https://github.com/fntlnz/fuse-example/blob/master/fuse-example.c">fuse-example.c</a></h3>
<p>Here&rsquo;s where the magic actually happen!</p>
<p>In this example I implemented four of the FUSE API callbacks namely: getattr, open, read, readdir.</p>
<h4 id="getattr">getattr</h4>
<p>The getattr callback is in charge of reading the metadata of a given path, this  callback is always called before any operation made on the filesystem.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getattr_callback</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">struct</span> stat <span style="color:#f92672">*</span>stbuf) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(stbuf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> stat));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(path, <span style="color:#e6db74">&#34;/&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    stbuf<span style="color:#f92672">-&gt;</span>st_mode <span style="color:#f92672">=</span> S_IFDIR <span style="color:#f92672">|</span> <span style="color:#ae81ff">0755</span>;
</span></span><span style="display:flex;"><span>    stbuf<span style="color:#f92672">-&gt;</span>st_nlink <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(path, filepath) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    stbuf<span style="color:#f92672">-&gt;</span>st_mode <span style="color:#f92672">=</span> S_IFREG <span style="color:#f92672">|</span> <span style="color:#ae81ff">0777</span>;
</span></span><span style="display:flex;"><span>    stbuf<span style="color:#f92672">-&gt;</span>st_nlink <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    stbuf<span style="color:#f92672">-&gt;</span>st_size <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(filecontent);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOENT;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>What we are doing here is simple:</p>
<ul>
<li>if the value of path equals to root <code>/</code>, we declare it as a directory and return.</li>
<li>if the value of path equals to filepath <code>/file</code>, we declare it as a file and explicit its size and then return.</li>
<li>Otherwise nothing exists at the given path, and we return <code>-ENOENT</code>.</li>
</ul>
<p>As you can see, we are telling FUSE that the current entry is a file or a directory using the <code>stat</code> struct.</p>
<p>In general, if the entry is a directory, <code>st_mode</code> have to be set to <code>S_IFDIR</code> and <code>st_nlink</code> to 2, while if it&rsquo;s a file, <code>st_mode</code> have to be set to <code>S_IFREG</code> (that stands for regular file) and <code>st_nlink</code> to 1. Files also require that the <code>st_size</code> (the full file size) is specified.</p>
<p><a href="http://pubs.opengroup.org/onlinepubs/007908799/xsh/sysstat.h.html">Here</a> you can find more information about <code>&lt;sys/stat.h&gt;</code></p>
<h4 id="open">open</h4>
<p>The open callback is called when the system requests for a file to be opened. Since we don&rsquo;t have real file but only in-memory representations, we are going to implement this callback just because is needed for FUSE to work and therefore return 0.</p>
<h4 id="read">read</h4>
<p>This callback is called when FUSE is reading data from an opened file.
It should return exactly the number of bytes requested and fill the second argument <code>buf</code> with the content of those bytes.
As done in the getattr callback, here I&rsquo;m checking if the given path equals to a known one, I copy the <code>filecontent</code> into the <code>buf</code> and then return the requested number of bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read_callback</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">size_t</span> size, <span style="color:#66d9ef">off_t</span> offset,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> fuse_file_info <span style="color:#f92672">*</span>fi) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(path, filepath) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> len <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(filecontent);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (offset <span style="color:#f92672">&gt;=</span> len) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (offset <span style="color:#f92672">+</span> size <span style="color:#f92672">&gt;</span> len) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memcpy</span>(buf, filecontent <span style="color:#f92672">+</span> offset, len <span style="color:#f92672">-</span> offset);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> len <span style="color:#f92672">-</span> offset;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(buf, filecontent <span style="color:#f92672">+</span> offset, size);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> size;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOENT;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="readdir">readdir</h4>
<p>The readdir callback has the task of telling FUSE the exact structure of the accessed directory.
Since at the moment the only available directory is <code>/</code>, this function always return its representation, we are doing it by filling <code>buf</code> with the two links for the upper directory <code>..</code> and current directory <code>.</code> and with the only file we have: <code>file</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">readdir_callback</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">fuse_fill_dir_t</span> filler,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">off_t</span> offset, <span style="color:#66d9ef">struct</span> fuse_file_info <span style="color:#f92672">*</span>fi) {
</span></span><span style="display:flex;"><span>  (<span style="color:#66d9ef">void</span>) offset;
</span></span><span style="display:flex;"><span>  (<span style="color:#66d9ef">void</span>) fi;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">filler</span>(buf, <span style="color:#e6db74">&#34;.&#34;</span>, NULL, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">filler</span>(buf, <span style="color:#e6db74">&#34;..&#34;</span>, NULL, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">filler</span>(buf, filename, NULL, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="main">main</h4>
<p>Last but not least, the <code>main</code> function here is acting as a proxy to the <code>fuse_main</code> passing arguments through it and configuring it with the implemented FUSE operation callbacks via the <code>fuse_example_operations</code> variable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> fuse_operations fuse_example_operations <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  .getattr <span style="color:#f92672">=</span> getattr_callback,
</span></span><span style="display:flex;"><span>  .open <span style="color:#f92672">=</span> open_callback,
</span></span><span style="display:flex;"><span>  .read <span style="color:#f92672">=</span> read_callback,
</span></span><span style="display:flex;"><span>  .readdir <span style="color:#f92672">=</span> readdir_callback,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fuse_main</span>(argc, argv, <span style="color:#f92672">&amp;</span>fuse_example_operations, NULL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="build-and-run">Build and run</h3>
<p>Do you remember that you installed CMake, make, gcc and libfuse? It&rsquo;s time to use them!</p>
<p>The first tool we are using is CMake to <strong>check dependencies, setup environment and generate Makefiles</strong>.</p>
<pre tabindex="0"><code>cmake -DCMAKE_BUILD_TYPE=Debug .
</code></pre><p>If you don&rsquo;t want Debug flags and other development related enabled features, just change <code>Debug</code> to <code>Release</code></p>
<p>The second tool we are using is <code>make</code>, that using the CMake generated <strong>Makefiles</strong> is now able to build our project.</p>
<pre tabindex="0"><code>make -j
</code></pre><p>The <code>-j</code> parts tells make to parallelize the build to all your cores, remove it if you run out of CPU.</p>
<p>Now that everything is ready, if no build error has occurred, we can enjoy our new filesystem!</p>
<h3 id="run">Run!</h3>
<p>Before doing anything we need a mountpoint, so let&rsquo;s create the directory where the filesystem will be mounted:</p>
<pre tabindex="0"><code>mkdir /tmp/example
</code></pre><p>and then, mount the filesystem:</p>
<pre tabindex="0"><code>./bin/fuse-example -d -s -f /tmp/example
</code></pre><p>Now check that it has been mounted:</p>
<pre tabindex="0"><code>$ ls -la
total 0
drwxr-xr-x.  2 root root   0 Jan  1  1970 .
drwxrwxrwt. 14 root root 320 Jan 10 16:03 ..
-rwxrwxrwx.  1 root root  49 Jan  1  1970 file
</code></pre><pre tabindex="0"><code>$ mount | grep fuse-example
fuse-example on /tmp/example type fuse.fuse-example (rw,nosuid,nodev,relatime,user_id=1000,group_id=1000)
</code></pre><p>As you may notice, we mounted the filesystem with three arguments which are:</p>
<ul>
<li><strong>d</strong>: enable debugging</li>
<li><strong>s</strong>: run single threaded</li>
<li><strong>f</strong>: stay in foreground</li>
</ul>
<p>You can see the list of all mount options using <code>-h</code>.</p>
<h2 id="thoughts-and-notes">Thoughts and notes</h2>
<ul>
<li>An important thing to notice is that write and read operations by default have a size of 4kb so if your file is, let&rsquo;s say, 399kb you have to deal with the fact that to read it the read callback will be called 100 times with 100 different offset and 99 equals size but one that will have 3kb as size because the file is 399kb and not 400kb so the latest chunk has size 3kb and not 4kb.</li>
<li>FUSE is more secure than low level kernel development, but security is not free so if you are going to write a network filesystem, for example you may want not to mount it as root.</li>
<li>By default, accessing the mounted filesystem for other users is not allowed.</li>
</ul>
<h2 id="other-resources">Other resources</h2>
<ul>
<li><a href="https://github.com/hanwen/go-fuse">Fuse bindings in Go</a></li>
<li><a href="https://github.com/bcle/fuse4js">Fuse bindings in NodeJS</a></li>
<li><a href="https://github.com/terencehonles/fusepy">Fuse bindings in Python</a></li>
<li><a href="https://github.com/EtiennePerot/fuse-jna">Fuse bindings in Java</a></li>
<li><a href="https://github.com/libfuse/libfuse/tree/master/example">Other examples in C</a></li>
</ul>
<p>These were my 2 cents, if you are interested in seeing something from me I started a little project on GitHub to create a filesystem that can use online services via FUSE to store data. You can find the project here: <a href="https://github.com/fntlnz/webfs">WebFS on GitHub</a>.</p>
<p>Thanks for reading!</p>

  </div>

  

  <footer>
    <ul class="stats">
  <li class="categories">
    <ul>
        
            
            
                <i class="fa-solid fa-folder"></i>
                
                
                <li><a class="article-category-link" href="https://engineering.facile.it/categories/english">English</a></li>
                
                
                <li><a class="article-category-link" href="https://engineering.facile.it/categories/fuse">Fuse</a></li>
                
                
                <li><a class="article-category-link" href="https://engineering.facile.it/categories/filesystem">Filesystem</a></li>
                
                
                <li><a class="article-category-link" href="https://engineering.facile.it/categories/c">C</a></li>
                
                
                <li><a class="article-category-link" href="https://engineering.facile.it/categories/cmake">CMake</a></li>
                
            
        
    </ul>
  </li>
  <li class="tags">
    <ul>
        
    </ul>
  </li>
</ul>

  </footer>

</article>


<ul class="actions pagination">
    
        <li><a href="/blog/ita/puli-universal-packages-for-php/"
                class="button big previous">Puli: Universal Packages for PHP</a></li>
    

    
        <li><a href="/blog/eng/graphql-an-introduction/"
                class="button big next">GraphQL: an introduction</a></li>
    
</ul>


    </div>
    
<section id="sidebar">

  
  <section id="intro">
    
    
      
        <a href='/'><img src="/images/logo_engineering.png" width="100%" alt="Facile.it Engineering" /></a>
      
    
    
      <header>
        <h2></h2>
        <p>News, repos, tips & trends from the Facile.it Engineering team!</p>
      </header>
    
    
      <ul class="icons">
        
          <li>
            <a href="" type="application/rss+xml" target="_blank" title="RSS" class="fa-solid fa-rss"></a>
          </li>
        
        
  <li><a href="//github.com/facile-it" target="_blank" title="GitHub" class="fa-brand fa-github"></a></li>



























  <li><a href="//linkedin.com/company/facile-it" target="_blank" title="LinkedIn Company" class="fa-brand fa-linkedin"></a></li>









  <li><a href="//facebook.com/facile.it" target="_blank" title="Facebook" class="fa-brands fa-facebook-square"></a></li>









  <li><a href="//youtube.com/user/Facileit" target="_blank" title="YouTube" class="fa-brand fa-youtube"></a></li>













  <li><a href="//instagram.com/facile.it" target="_blank" title="Instagram" class="fa-brand fa-instagram"></a></li>





  <li><a href="//x.com/FacileIt_Engr" target="_blank" title="Twitter" class="fa-brand fa-square-x-twitter"></a></li>























      </ul>
    
  </section>

  
  <section class="recent-posts">
    <div class="mini-posts">
      <header>
        <h3>Recent Posts</h3>
      </header>
      <div class="posts-container">
        

        
          
        

        
          <article class="mini-post">
            <header>
              <div class="author-avatars">
                
                  
                    <a href="/authors/agiorgianni/" class="author" title="See other posts from Alessio Giorgianni">
                      <img src="https://www.gravatar.com/avatar" alt="Alessio Giorgianni avatar" class="author-avatar"/>
                    </a>
                  
                
                  
                    <a href="/authors/mgarza/" class="author" title="See other posts from Matteo Garza">
                      <img src="/images/avatar-mgarza.jpeg" alt="Matteo Garza avatar" class="author-avatar"/>
                    </a>
                  
                
              </div>

              <h3>
                <a href="/blog/eng/hack-the-box-experience/">Hack the Box Experience</a>
              </h3>
              
              <time class="published" datetime='2024-05-30'>
                30 May 2024
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <div class="author-avatars">
                
                  
                    <a href="/authors/engineering/" class="author" title="See other posts from Facile.it engineers">
                      <img src="https://avatars1.githubusercontent.com/u/8501934?v=3&amp;s=200" alt="Facile.it engineers avatar" class="author-avatar"/>
                    </a>
                  
                
              </div>

              <h3>
                <a href="/blog/eng/v-protetto17-5-2024/">Venerdì Protetto | May 2024 edition</a>
              </h3>
              
              <time class="published" datetime='2024-05-20'>
                20 May 2024
              </time>
            </header>
            

          </article>
        
          <article class="mini-post">
            <header>
              <div class="author-avatars">
                
                  
                    <a href="/authors/mgarza/" class="author" title="See other posts from Matteo Garza">
                      <img src="/images/avatar-mgarza.jpeg" alt="Matteo Garza avatar" class="author-avatar"/>
                    </a>
                  
                
                  
                    <a href="/authors/ana-radujko/" class="author" title="See other posts from Ana Radujko">
                      <img src="https://s.gravatar.com/avatar/13c2d19c1d59562ca74b71f5444943c5?s=80" alt="Ana Radujko avatar" class="author-avatar"/>
                    </a>
                  
                
              </div>

              <h3>
                <a href="/blog/eng/v-protetto8-3-2024/">Venerdì Protetto | March edition</a>
              </h3>
              
              <time class="published" datetime='2024-03-11'>
                11 March 2024
              </time>
            </header>
            

          </article>
        
      </div>

      
        <a href=
          
            /blog/
          
        class="button">View more posts</a>
      
    </div>
  </section>

  
  
  
  
  
    <section id="categories">
      <header>
        <h3>
          <a href="/categories/">Top categories</a></h3>
      </header>
        
          
        

        
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/conferences/">Conferences</a>
                <span style="float:right;">10</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/docker/">Docker</a>
                <span style="float:right;">6</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/english/">English</a>
                <span style="float:right;">41</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/functional-programming/">Functional Programming</a>
                <span style="float:right;">11</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/italiano/">Italiano</a>
                <span style="float:right;">34</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/oop/">OOP</a>
                <span style="float:right;">6</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/open-source/">Open Source</a>
                <span style="float:right;">7</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/php/">PHP</a>
                <span style="float:right;">23</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/protected-fridays/">Protected Fridays</a>
                <span style="float:right;">14</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/software-testing/">Software Testing</a>
                <span style="float:right;">7</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/swift/">Swift</a>
                <span style="float:right;">8</span>
              
            </header>
          </article>
        </p>
        
    
            
        <p>
          <article>
            <header>
              
                <a href="https://engineering.facile.it/categories/symfony/">Symfony</a>
                <span style="float:right;">5</span>
              
            </header>
          </article>
        </p>
        
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
            
    
        <p>
            <a href="/categories/" class="button">View more categories</a>
        </p>
    </section>
  
  

  
  
    <section id="mini-bio">
      <h3>About</h3>
      <p>Facile.it relies on a big and keen crew of developers. Since 2008, the group’s projects are based on PHP, and as time goes by new technologies become part of corporate know how. This blog allows our developers to share tips and direct experiences with new technologies.</p>
      <a href="/ita/chi-siamo/" class="button">Learn More</a>
    </section>
  

  
  <section id="footer">
    
      <ul class="icons">
        
          <li>
            <a href="" type="application/rss+xml" target="_blank" title="RSS" class="fa-solid fa-rss"></a>
          </li>
        
        
  <li><a href="//github.com/facile-it" target="_blank" title="GitHub" class="fa-brand fa-github"></a></li>



























  <li><a href="//linkedin.com/company/facile-it" target="_blank" title="LinkedIn Company" class="fa-brand fa-linkedin"></a></li>









  <li><a href="//facebook.com/facile.it" target="_blank" title="Facebook" class="fa-brands fa-facebook-square"></a></li>









  <li><a href="//youtube.com/user/Facileit" target="_blank" title="YouTube" class="fa-brand fa-youtube"></a></li>













  <li><a href="//instagram.com/facile.it" target="_blank" title="Instagram" class="fa-brand fa-instagram"></a></li>





  <li><a href="//x.com/FacileIt_Engr" target="_blank" title="Twitter" class="fa-brand fa-square-x-twitter"></a></li>























      </ul>
    
    <p class="copyright">
      
        &copy; 2024
        
          Facile.it Engineering
        
      .
      <a href="/ita/disclaimer/" rel="nofollow">Disclaimer</a><br>
      Design <a href="http://html5up.net" rel="nofollow" target="_blank">HTML5 UP</a><br>
      Ported by <a href="//github.com/jpescador" rel="nofollow" target="_blank">Julio Pescador</a><br>
      Modified by <a href="//github.com/Jean85" rel="nofollow" target="_blank">Alessandro Lai</a><br>
      Powered by <a href="//gohugo.io" target="_blank">Hugo</a>
    </p>
  </section>
</section>

    </div>
    <a id="back-to-top" href="#" class="fa-solid fa-arrow-up fa-border fa-2x"></a>
    

    
      
    

    
      
      
      
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
        
        
        
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/kotlin.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/objectivec.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/python.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/swift.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
      
    
    
    
      <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>
      <script src="/js/util.js"></script>
      <script src="/js/main.js"></script>
      <script src="/js/backToTop.js"></script>
      <script type="text/javascript" src="/js/jquery-lazy/jquery.lazy.min.js"></script>
    

    

    
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="//yihui.name/js/math-code.js"></script>
<script async
src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    <script type="text/javascript">
        $(function() {
            $('.lazy').Lazy();
        });
    </script>
  </body>
</html>

